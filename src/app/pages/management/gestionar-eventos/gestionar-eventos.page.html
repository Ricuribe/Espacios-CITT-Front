<ion-header [translucent]="true" class="main-header">
  <ion-toolbar class="main-toolbar">
    <ion-buttons slot="start">
      <ion-menu-button color="light"></ion-menu-button>
    </ion-buttons>
    <ion-title>Gesti贸n de Eventos</ion-title>
  </ion-toolbar>
  
  <ion-toolbar class="filter-toolbar">
    <ion-segment [value]="currentStatus()" (ionChange)="segmentChanged($event)" scrollable mode="md">
      <ion-segment-button value="1">
        <ion-label>Pendientes</ion-label>
      </ion-segment-button>
      <ion-segment-button value="2">
        <ion-label>Confirmados</ion-label>
      </ion-segment-button>
      <ion-segment-button value="0">
        <ion-label>Cancelados</ion-label>
      </ion-segment-button>
      <ion-segment-button value="all">
        <ion-label>Todos</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="content-bg">
  
  <ion-refresher slot="fixed" (ionRefresh)="loadEvents($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="container">
    
    <div *ngIf="isLoading()" class="center-msg">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p>Cargando eventos...</p>
    </div>

    <div *ngIf="!isLoading() && events().length === 0" class="center-msg empty-state">
      <ion-icon name="calendar-outline"></ion-icon>
      <p>No hay eventos en este estado.</p>
    </div>

    <div class="events-grid" *ngIf="!isLoading()">
      
      <ion-card *ngFor="let ev of events()" class="event-card" (click)="openDetail(ev)">
        <div class="card-status-bar" [style.background-color]="'var(--ion-color-' + getStatusColor(ev.status) + ')'"></div>
        
        <ion-card-header>
          <div class="status-badge">
            <ion-chip [color]="getStatusColor(ev.status)" outline="true">
              {{ getStatusLabel(ev.status) }}
            </ion-chip>
            <span class="date">{{ ev.start_datetime | date:'dd/MM/yyyy' }}</span>
          </div>
          <ion-card-title>{{ ev.title }}</ion-card-title>
          <ion-card-subtitle>{{ ev.creator?.username || ev.created_by_username }}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <div class="info-row">
            <ion-icon name="time-outline"></ion-icon>
            <span>{{ ev.start_datetime | date:'HH:mm' }} - {{ ev.end_datetime | date:'HH:mm' }}</span>
          </div>
        </ion-card-content>
      </ion-card>

    </div>
  </div>

  <ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Detalle del Evento</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content class="modal-content">
        
        <div *ngIf="loadingDetail" class="center-msg">
          <ion-spinner></ion-spinner>
        </div>

        <div *ngIf="!loadingDetail && selectedEvent" class="detail-wrapper">
          
          <div class="modal-header-section">
            <ion-chip [color]="getStatusColor(selectedEvent.status)" class="status-chip-lg">
              {{ getStatusLabel(selectedEvent.status) }}
            </ion-chip>
            <h1>{{ selectedEvent.title }}</h1>
            <p class="subtitle">{{ selectedEvent.detail?.event_type || 'Evento General' }}</p>
          </div>

          <div class="info-block">
            <h3>Informaci贸n General</h3>
            <ion-list lines="none">
              <ion-item>
                <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <h2>Fecha</h2>
                  <p>{{ selectedEvent.start_datetime | date:'fullDate' }}</p>
                </ion-label>
              </ion-item>
              <ion-item>
                <ion-icon name="time-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <h2>Horario</h2>
                  <p>{{ selectedEvent.start_datetime | date:'HH:mm' }} - {{ selectedEvent.end_datetime | date:'HH:mm' }}</p>
                </ion-label>
              </ion-item>
              <ion-item>
                <ion-icon name="people-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <h2>Asistentes</h2>
                  <p>{{ selectedEvent.detail?.attendees || 0 }} personas</p>
                </ion-label>
              </ion-item>
              <ion-item>
                <ion-icon name="person-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <h2>Organizador</h2>
                  <p>{{ selectedEvent.creator?.username }}</p>
                  <p class="small-email">{{ selectedEvent.creator?.email }}</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </div>

          <div class="info-block">
            <h3>Descripci贸n</h3>
            <div class="desc-box">
              {{ selectedEvent.detail?.description || 'Sin descripci贸n.' }}
            </div>
          </div>

        </div>
      </ion-content>

      <ion-footer *ngIf="!loadingDetail && selectedEvent">
        <ion-toolbar>
          <div class="actions-grid">
            
            <ion-button fill="outline" color="medium" (click)="editEvent()">
              <ion-icon name="create-outline" slot="start"></ion-icon>
              Editar
            </ion-button>

            <ng-container *ngIf="selectedEvent.status === 1">
              <ion-button color="danger" fill="outline" (click)="confirmChangeStatus(0)">
                Rechazar
              </ion-button>
              <ion-button color="success" (click)="confirmChangeStatus(2)">
                Confirmar
              </ion-button>
            </ng-container>

            <ng-container *ngIf="selectedEvent.status === 2">
              <ion-button expand="block" color="danger" class="full-width-btn" (click)="confirmChangeStatus(0)">
                <ion-icon name="close-circle-outline" slot="start"></ion-icon>
                Cancelar Evento
              </ion-button>
            </ng-container>

             <ng-container *ngIf="selectedEvent.status === 0">
              <ion-button expand="block" color="warning" class="full-width-btn" (click)="confirmChangeStatus(1)">
                Re-Agendar
              </ion-button>
            </ng-container>

          </div>
        </ion-toolbar>
      </ion-footer>
    </ng-template>
  </ion-modal>

  <app-footer></app-footer>
</ion-content>