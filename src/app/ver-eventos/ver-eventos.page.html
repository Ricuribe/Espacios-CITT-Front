<ion-header class="main-header" [translucent]="true">
  <ion-toolbar class="main-toolbar">
    
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" color="light">
        <ion-icon name="arrow-back-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-menu-button color="light" menu="menu-eventos" class="mobile-only-button"></ion-menu-button>
    </ion-buttons>

    <img src="/assets/icon/Gemvirt_logo.png" alt="Logo GemVirt" class="logo">

    <ion-buttons slot="end" class="desktop-only-buttons">
      @if (!isLoggedIn()) {
        <ion-button class="btn-register" fill="solid" color="light" [routerLink]="['/registro']">Registrarse</ion-button>
        <ion-button class="btn-login" fill="outline" color="light" [routerLink]="['/login']">Iniciar Sesión</ion-button>
      }

      @if (isLoggedIn()) {
        <ion-chip class="user-chip">
          <ion-avatar><img src="https://ionicframework.com/docs/img/demos/avatar.svg" /></ion-avatar>
          <ion-label>{{ userName() }}</ion-label>
        </ion-chip>
        <ion-button class="btn-logout" fill="solid" color="light" (click)="logout()">Cerrar Sesión</ion-button>
      }
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-menu contentId="public-events-content" type="overlay" menuId="menu-eventos">
  <ion-header>
    <ion-toolbar>
      <ion-title>Menú</ion-title>
    </ion-toolbar>
  </ion-header>
  <ion-content>
    <ion-list lines="none">
      <ion-item button (click)="goBack()"><ion-icon name="home-outline" slot="start"></ion-icon><ion-label>Inicio</ion-label></ion-item>
      @if (isLoggedIn()) {
        <ion-item button (click)="logout()" class="logout-item"><ion-icon name="log-out-outline" slot="start"></ion-icon><ion-label>Cerrar Sesión</ion-label></ion-item>
      } @else {
        <ion-item button [routerLink]="['/login']"><ion-icon name="log-in-outline" slot="start"></ion-icon><ion-label>Iniciar Sesión</ion-label></ion-item>
      }
    </ion-list>
  </ion-content>
</ion-menu>

<ion-content [fullscreen]="true" id="public-events-content">
  
  <div class="page-container">
    
    <div class="hero-text">
      <h1>Cartelera de Eventos</h1>
      <p>Descubre las actividades del CITT</p>
    </div>

    <div class="filter-wrapper">
      <ion-segment [value]="filterToday() ? 'today' : 'all'" (ionChange)="segmentChanged($event)" mode="ios">
        <ion-segment-button value="all">
          <ion-label>Próximos</ion-label>
        </ion-segment-button>
        <ion-segment-button value="today">
          <ion-label>Hoy</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    @if (isLoading()) {
      <div class="loader">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
      </div>
    }

    @if (!isLoading() && eventos().length === 0) {
      <div class="empty-state">
        <ion-icon name="alert-circle-outline"></ion-icon>
        <p>No hay eventos programados {{ filterToday() ? 'para hoy' : 'próximamente' }}.</p>
      </div>
    }

    <div class="events-list" *ngIf="!isLoading()">
      @for (ev of eventos(); track ev.id_event) {
        
        <div class="event-card" [class.expanded]="expandedEventId() === ev.id_event" (click)="toggleExpand(ev.id_event)">
          
          <div class="card-header">
            
            <div class="date-box">
              <span class="day">{{ ev.start_datetime | date:'dd' }}</span>
              <span class="month">{{ ev.start_datetime | date:'MMM' }}</span>
            </div>
            
            <div class="info-main">
              <div class="top-row">
                <ion-chip [color]="getStatusColor(ev.status)" class="status-chip">{{ getStatusLabel(ev.status) }}</ion-chip>
                <span class="type-badge">{{ ev.event_type }}</span>
              </div>
              
              <h2>{{ ev.title }}</h2>
              
              <div class="time-row">
                <ion-icon name="time-outline"></ion-icon>
                <span>{{ ev.start_datetime | date:'HH:mm' }} - {{ ev.end_datetime | date:'HH:mm' }}</span>
              </div>
            </div>

            <div class="arrow-indicator">
              <ion-icon [name]="expandedEventId() === ev.id_event ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
            </div>
          </div>

          <div class="card-detail" *ngIf="expandedEventId() === ev.id_event">
            <hr class="divider">
            
            <p class="description">{{ ev.description }}</p>
            
            <div class="contact-info" *ngIf="ev.created_by_email">
              <ion-icon name="mail-outline"></ion-icon>
              <span>Contacto: <a href="mailto:{{ev.created_by_email}}" (click)="$event.stopPropagation()">{{ ev.created_by_email }}</a></span>
            </div>

            <div class="invitation-box" *ngIf="ev.form_public_link">
              <div class="qr-wrapper">
                <qrcode [qrdata]="ev.form_public_link" [width]="100" [errorCorrectionLevel]="'M'" colorDark="#000000" colorLight="#ffffff"></qrcode>
              </div>
              <div class="link-wrapper">
                <p><strong>¡Inscríbete!</strong> Escanea o haz clic:</p>
                <ion-button fill="outline" size="small" (click)="openLink(ev.form_public_link); $event.stopPropagation()">
                  <ion-icon name="link-outline" slot="start"></ion-icon>
                  Ir al Formulario
                </ion-button>
              </div>
            </div>

          </div>

        </div>
      }
    </div>

  </div>

  <app-footer></app-footer>
</ion-content>